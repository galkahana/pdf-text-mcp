# Default values for pdf-text-mcp-server (Production)
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 3

image:
  repository: pdf-text-mcp-server
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "optimized"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}

podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  capabilities:
    drop:
    - ALL

service:
  type: ClusterIP
  port: 80
  targetPort: 3000

ingress:
  enabled: false
  className: "nginx"
  annotations: {}
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: mcp.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: pdf-text-mcp-tls
  #    hosts:
  #      - mcp.example.com

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: false
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

# Application configuration
config:
  transportMode: "http"
  port: 3000
  host: "0.0.0.0"
  maxFileSize: 104857600  # 100MB
  timeout: 30000  # 30 seconds

# API Key authentication (optional)
# Set this to enable API key authentication
# Can also be set via --set apiKey=your-key during helm install
apiKey: ""

# Probes configuration
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

# Observability configuration
observability:
  # Enable/disable Prometheus monitoring
  prometheus:
    enabled: false

  # Enable/disable Loki logging
  loki:
    enabled: false

# kube-prometheus-stack configuration (when observability.prometheus.enabled=true)
kube-prometheus-stack:
  # Prometheus configuration
  prometheus:
    prometheusSpec:
      retention: 7d
      resources:
        requests:
          memory: 512Mi
          cpu: 250m
        limits:
          memory: 1Gi
          cpu: 500m
      # ServiceMonitor selector - discovers ServiceMonitors with this label
      serviceMonitorSelector:
        matchLabels:
          app.kubernetes.io/part-of: pdf-text-mcp
      # Additional scrape configs for direct service scraping
      additionalScrapeConfigs:
        - job_name: 'pdf-mcp-server'
          static_configs:
            - targets: ['pdf-text-mcp-pdf-text-mcp-server:80']
          metrics_path: '/metrics'

  # Grafana configuration
  grafana:
    enabled: true
    adminPassword: admin
    service:
      type: NodePort
      nodePort: 30300
    # Pre-configured data sources
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://kube-prometheus-stack-prometheus:9090
            access: proxy
            isDefault: true
          - name: Loki
            type: loki
            url: http://loki:3100
            access: proxy
            isDefault: false
    # Dashboard provisioning
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'pdf-mcp'
            orgId: 1
            folder: 'PDF MCP Server'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/pdf-mcp
    # Import dashboards from ConfigMaps
    dashboards:
      pdf-mcp:
        pdf-mcp-overview:
          gnetId: null
          datasource: Prometheus
        pdf-mcp-logs:
          gnetId: null
          datasource: Loki

  # Alertmanager configuration
  alertmanager:
    enabled: true
    config:
      global:
        resolve_timeout: 5m
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 12h
        receiver: 'default'
      receivers:
        - name: 'default'
          # Add webhook, email, or other notification configs here
      inhibit_rules:
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'cluster', 'service']

# loki-stack configuration (when observability.loki.enabled=true)
loki-stack:
  loki:
    enabled: true
    persistence:
      enabled: false
    config:
      auth_enabled: false
      ingester:
        chunk_idle_period: 3m
        chunk_block_size: 262144
        chunk_retain_period: 1m
        max_transfer_retries: 0
        lifecycler:
          ring:
            kvstore:
              store: inmemory
            replication_factor: 1
      limits_config:
        retention_period: 168h  # 7 days
        enforce_metric_name: false
        reject_old_samples: true
        reject_old_samples_max_age: 168h
      schema_config:
        configs:
          - from: 2020-10-24
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h
      server:
        http_listen_port: 3100
      storage_config:
        boltdb_shipper:
          active_index_directory: /data/loki/boltdb-shipper-active
          cache_location: /data/loki/boltdb-shipper-cache
          cache_ttl: 24h
          shared_store: filesystem
        filesystem:
          directory: /data/loki/chunks
      chunk_store_config:
        max_look_back_period: 0s
      table_manager:
        retention_deletes_enabled: true
        retention_period: 168h
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 200m

  promtail:
    enabled: true
    config:
      clients:
        - url: http://{{ .Release.Name }}-loki:3100/loki/api/v1/push
      snippets:
        pipelineStages:
          - cri: {}
          - json:
              expressions:
                level: level
                timestamp: timestamp
                message: message
                correlationId: correlationId
                toolName: toolName
                fileSize: fileSize
                pageCount: pageCount
                processingTime: processingTime
          - labels:
              level:
              correlationId:
              toolName:
          - timestamp:
              source: timestamp
              format: RFC3339
    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 256Mi
        cpu: 200m
